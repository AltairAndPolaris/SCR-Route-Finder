<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SCR Route Finder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    margin: 0;
    padding: 20px;
}
.container { max-width: 1200px; margin: auto; }
.card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
}
.header { color: white; text-align: center; margin-bottom: 30px; }
select, input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
button {
    padding: 14px;
    width: 100%;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
}
.route-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border-left: 5px solid #667eea;
}
.route-step {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 6px;
}
.operator-badge {
    padding: 3px 8px;
    border-radius: 4px;
    color: white;
    font-size: 0.75rem;
    font-weight: bold;
}
.operator-CN { background:#0096EE }
.operator-MT { background:#EE4044 }
.operator-WL { background:#002D5F }
.operator-AL { background:#EC7D33 }
.operator-EX { background:#FF0080 }
.transfer { background:#e74c3c; color:white; padding:4px 10px; border-radius:12px; display:inline-block; margin:6px 0 }
.same-routes { font-size:0.85rem; margin-left:16px; color:#555 }
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>SCR Route Finder</h1>
        <p>Stepford County Railway</p>
    </div>

    <div class="card">
        <label>From</label>
        <select id="from"></select>

        <label>To</label>
        <select id="to"></select>

        <h3>Pricing (per station)</h3>
        <div id="pricing"></div>

        <br>
        <button onclick="compute()">Find Routes</button>
    </div>

    <div id="output"></div>
</div>

<script>
/* ================= DATA ================= */

const DEFAULT_PRICES = { CN:5, MT:3, WL:7, AL:10, EX:15 };
const ROUTE_INDEX = new Map();

let GRAPH, OPERATORS, STATION_NAMES;

/* ================= PARSE ================= */

function parseRouteFile(text) {
    const graph = new Map();
    const stations = new Set();
    const operators = new Set();

    function addEdge(a,b,route,op,time){
        if(!graph.has(a)) graph.set(a,[]);
        graph.get(a).push({to:b,route,operator:op,time});
    }

    text.split("//").filter(Boolean).forEach(r=>{
        const [op,routeId,data]=r.split("/");
        operators.add(op);
        const list=data.split(";").map(s=>{
            const [n,t]=s.split(",");
            return {name:n,time:+t};
        });

        ROUTE_INDEX.set(routeId,{operator:op,stations:list.map(x=>x.name)});

        for(let i=0;i<list.length-1;i++){
            const dt=list[i+1].time-list[i].time;
            addEdge(list[i].name,list[i+1].name,routeId,op,dt);
            addEdge(list[i+1].name,list[i].name,routeId,op,dt);
            stations.add(list[i].name);
            stations.add(list[i+1].name);
        }
    });

    return {graph,stations:[...stations].sort(),operators:[...operators]};
}

/* ================= QUEUE ================= */

class PQ{
    constructor(c){this.d=[];this.c=c}
    push(x){this.d.push(x);this.d.sort(this.c)}
    pop(){return this.d.shift()}
    get size(){return this.d.length}
}

/* ================= PATHFINDING ================= */

function findPath(graph,from,to,mode,pricing){
    const PEN=5;
    const pq=new PQ((a,b)=>{
        if(mode==="direct"){
            return a.transfers-b.transfers || a.time-b.time;
        }
        if(mode==="cheap"){
            return a.cost-b.cost || a.time-b.time;
        }
        return (a.time+a.transfers*PEN)-(b.time+b.transfers*PEN);
    });

    const best=new Map();

    for(const e of graph.get(from)||[]){
        const s={station:from,route:e.route,operator:e.operator,time:0,transfers:0,cost:0,path:[]};
        best.set(from+"|"+e.route,s);
        pq.push(s);
    }

    while(pq.size){
        const cur=pq.pop();
        if(cur.station===to) return cur;

        for(const e of graph.get(cur.station)||[]){
            const tr=e.route!==cur.route;
            const next={
                station:e.to,
                route:e.route,
                operator:e.operator,
                time:cur.time+e.time,
                transfers:cur.transfers+(tr?1:0),
                cost:cur.cost+(pricing[e.operator]||0),
                path:cur.path.concat({from:cur.station,to:e.to,route:e.route,operator:e.operator,time:e.time,transfer:tr})
            };
            const key=e.to+"|"+e.route;
            const prev=best.get(key);

            let better=!prev;
            if(prev){
                if(mode==="direct") better=next.transfers<prev.transfers||next.transfers===prev.transfers&&next.time<prev.time;
                else if(mode==="cheap") better=next.cost<prev.cost||next.cost===prev.cost&&next.time<prev.time;
                else better=(next.time+next.transfers*PEN)<(prev.time+prev.transfers*PEN);
            }

            if(better){best.set(key,next);pq.push(next);}
        }
    }
    return null;
}

/* ================= EQUIVALENT ROUTES ================= */

function findEquivalentRoutes(a,b,refRoute){
    const ref=ROUTE_INDEX.get(refRoute);
    if(!ref) return [];
    const i=ref.stations.indexOf(a);
    const j=ref.stations.indexOf(b);
    if(i<0||j<=i) return [];

    const seg=ref.stations.slice(i,j+1).join(">");

    return [...ROUTE_INDEX.entries()]
        .filter(([rid,info])=>{
            if(info.operator!==ref.operator) return false;
            const x=info.stations.indexOf(a);
            const y=info.stations.indexOf(b);
            if(x<0||y<=x) return false;
            return info.stations.slice(x,y+1).join(">")===seg;
        })
        .map(([rid])=>rid);
}

/* ================= UI ================= */

fetch("station.txt").then(r=>r.text()).then(t=>{
    STATION_NAMES={};
    t.split("/").forEach(e=>{
        const [c,n]=e.split(";");
        if(c&&n) STATION_NAMES[c]=n;
    });
    return fetch("route.txt");
}).then(r=>r.text()).then(text=>{
    const {graph,stations,operators}=parseRouteFile(text);
    GRAPH=graph; OPERATORS=operators;

    const from=document.getElementById("from");
    const to=document.getElementById("to");

    stations.forEach(s=>{
        const n=STATION_NAMES[s]?`${s} - ${STATION_NAMES[s]}`:s;
        from.add(new Option(n,s));
        to.add(new Option(n,s));
    });

    const p=document.getElementById("pricing");
    operators.forEach(op=>{
        p.innerHTML+=`<div>
            <span class="operator-badge operator-${op}">${op}</span>
            <input id="p_${op}" type="number" value="${DEFAULT_PRICES[op]||10}">
        </div>`;
    });
});

/* ================= RENDER ================= */

function compute(){
    const from=document.getElementById("from").value;
    const to=document.getElementById("to").value;
    const pricing={};
    OPERATORS.forEach(op=>pricing[op]=+document.getElementById("p_"+op).value);
    const out=document.getElementById("output");
    out.innerHTML="";
    show("Balanced",findPath(GRAPH,from,to,"balanced",pricing));
    show("Direct",findPath(GRAPH,from,to,"direct",pricing));
    show("Cheapest",findPath(GRAPH,from,to,"cheap",pricing));
}

function show(title,r){
    if(!r){output.innerHTML+=`<div class="card">No route</div>`;return;}
    let h=`<div class="route-card"><h3>${title}</h3>
    ‚è± ${r.time} min | üîÑ ${r.transfers} | üíµ ${r.cost}<br><br>`;
    let cur=null;

    r.path.forEach(p=>{
        if(p.transfer) h+=`<div class="transfer">Transfer</div>`;
        h+=`<div class="route-step">
            ${p.from} ‚Üí ${p.to}
            <span class="operator-badge operator-${p.operator}">${p.route}</span>
            ${p.time} min
        </div>`;
        if(!p.transfer){
            const eq=findEquivalentRoutes(p.from,p.to,p.route).filter(x=>x!==p.route);
            if(eq.length){
                h+=`<div class="same-routes">Same service: ${eq.map(x=>`<span class="operator-badge operator-${p.operator}">${x}</span>`).join(" ")}</div>`;
            }
        }
        cur=p.route;
    });

    h+="</div>";
    output.innerHTML+=h;
}
</script>
</body>
</html>
